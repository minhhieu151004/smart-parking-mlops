# Workflow CI/CD : Tự động đóng gói và deploy CẢ HAI hàm Lambda lên AWS khi có push code vào thư mục 'lambda/'.

name: CI/CD - Deploy Lambda Functions

on:
  push:
    branches: [ main ]
    paths:
      - 'lambda/**'

jobs:
  # === JOB 1: Deploy Hàm Evaluate/Promote ===
  deploy-evaluate-lambda:
    name: Deploy Evaluate-Promote Lambda
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' 

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }} 

      - name: Build and Package Lambda (Evaluate)
        run: |
          echo "Bắt đầu đóng gói hàm evaluate-promote-trigger..."
          # 1. Tạo thư mục package (tên duy nhất)
          mkdir package_eval
          
          # 2. Cài đặt thư viện từ requirements.txt (nếu file tồn tại)
          if [ -f lambda/evaluate-promote-trigger/requirements.txt ]; then
            pip install \
              -r lambda/evaluate-promote-trigger/requirements.txt \
              -t ./package_eval
          fi
          
          # 3. Copy code Python vào thư mục 'package_eval'
          cp lambda/evaluate-promote-trigger/lambda_function.py ./package_eval/
          
          # 4. Nén (zip) toàn bộ nội dung của thư mục 'package_eval'
          cd package_eval
          zip -r ../lambda-eval-deploy.zip .
          cd ..
          echo "Đóng gói lambda-eval-deploy.zip hoàn tất."

      - name: Deploy to AWS Lambda (Evaluate)
        run: |
          aws lambda update-function-code \
            --function-name evaluate-promote-trigger \
            --zip-file fileb://lambda-eval-deploy.zip

  # === JOB 2: Deploy Hàm Run Prediction ===
  deploy-prediction-lambda:
    name: Deploy Run-Prediction Lambda
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Build and Package Lambda (Prediction)
        run: |
          echo "Bắt đầu đóng gói hàm run-prediction-trigger..."
          # Tạo thư mục package (tên duy nhất)
          mkdir package_pred
          
          # Cài đặt thư viện (nếu file requirements.txt tồn tại - file này có thể trống)
          if [ -f lambda/run-prediction-trigger/requirements.txt ]; then
            pip install \
              -r lambda/run-prediction-trigger/requirements.txt \
              -t ./package_pred
          fi
          
          # Copy code Python
          cp lambda/run-prediction-trigger/lambda_function.py ./package_pred/
          
          # Nén
          cd package_pred
          zip -r ../lambda-pred-deploy.zip .
          cd ..
          echo "Đóng gói lambda-pred-deploy.zip hoàn tất."

      - name: Deploy to AWS Lambda (Prediction)
        run: |
          aws lambda update-function-code \
            --function-name run-prediction-trigger \
            --zip-file fileb://lambda-pred-deploy.zip

  # === JOB 3: Deploy Hàm Daily Export (MỚI) ===
  deploy-export-lambda:
    name: Deploy Daily Export Lambda
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Build and Package Lambda (Export)
        run: |
          echo "Bắt đầu đóng gói hàm daily-export-to-s3..."
          mkdir package_export
          
          if [ -f lambda/daily-export-to-s3/requirements.txt ]; then
            pip install \
              -r lambda/daily-export-to-s3/requirements.txt \
              -t ./package_export \
              --platform manylinux2014_x86_64 \
              --only-binary=:all: \
              --upgrade
          fi
          
          # Copy code Python
          cp lambda/daily-export-to-s3/lambda_function.py ./package_export/
          
          # 4. Nén
          cd package_export
          zip -r ../lambda-export-deploy.zip .
          cd ..
          echo "Đóng gói lambda-export-deploy.zip hoàn tất."

      - name: Deploy to AWS Lambda (Export)
        run: |
          aws lambda update-function-code \
            --function-name daily-export-to-s3 \
            --zip-file fileb://lambda-export-deploy.zip